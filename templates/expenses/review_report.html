{% extends "base.html" %}
{% block title %}Review Expense Report{% endblock %}
{% block content %}
<h1 class="h3">Review Report #{{ report.id }}</h1>
<p><strong>Employee:</strong> {{ report.employee.first_name or report.employee.email }}</p>
<p><strong>Status:</strong> {{ report.status }}</p>

<form method="post">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <div class="table-responsive mb-3">
    <table class="table table-bordered align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Type</th>
          <th>GL</th>
          <th>Vendor</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Receipt</th>
          <th>Decision</th>
          <th>Reviewer Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for line in report.lines %}
        <tr>
          <td>{{ line.date.strftime('%Y-%m-%d') }}</td>
          <td>{{ line.expense_type }}</td>
          <td>{{ line.gl_account }}</td>
          <td>{{ line.vendor }}</td>
          <td>{{ line.description }}</td>
          <td>${{ '%.2f'|format(line.amount) }}</td>
          <td>
            {% if line.receipt_url %}
            <a href="{{ line.receipt_url }}" target="_blank" rel="noopener">View</a>
            {% else %}
            <span class="text-muted">None</span>
            {% endif %}
          </td>
          <td>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="line_{{ line.id }}_action"
                id="line-{{ line.id }}-approve"
                value="approve"
                required
                {% if line.review_status == "Approved" %}checked{% endif %}
              />
              <label class="form-check-label" for="line-{{ line.id }}-approve">
                Approve
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="line_{{ line.id }}_action"
                id="line-{{ line.id }}-reject"
                value="reject"
                {% if line.review_status == "Rejected" %}checked{% endif %}
              />
              <label class="form-check-label" for="line-{{ line.id }}-reject">
                Reject
              </label>
            </div>
            {% if line.review_status and line.review_status != "Pending" %}
            <span class="badge bg-secondary mt-2">{{ line.review_status }}</span>
            {% endif %}
          </td>
          <td>
            <textarea
              class="form-control"
              name="line_{{ line.id }}_comment"
              rows="2"
              placeholder="Required for rejects"
            >{{ line.review_comment or "" }}</textarea>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="alert alert-info">
    Review each line item and add a comment for any rejected expense.
  </div>
  <button class="btn btn-primary" type="submit">Submit Line Review</button>
</form>
{% endblock %}
