{% extends "base.html" %}
{% block title %}New Expense Report{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">New Expense Report</h1>
  <a class="btn btn-outline-secondary" href="{{ url_for('expenses.my_reports') }}">My Reports</a>
</div>
<p class="text-muted">Reference workbook: <strong>{{ reference_workbook }}</strong> (Blank Expense Report, GL Accounts, Data List).</p>
<form method="post" enctype="multipart/form-data" id="expense-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">Report Month</label>
      <input type="month" name="report_month" class="form-control" required />
    </div>
    <div class="col-md-4">
      <label class="form-label">Supervisor</label>
      <select class="form-select" name="supervisor_id" required>
        <option value="">Select supervisor</option>
        {% for supervisor in supervisors %}
        <option value="{{ supervisor.id }}">{{ supervisor.first_name or '' }} {{ supervisor.last_name or supervisor.email }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Notes</label>
      <input name="notes" class="form-control" maxlength="255" />
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="expense-lines-table">
      <thead class="table-light">
        <tr>
          <th>Date</th><th>Type</th><th>Account</th><th>Description</th><th>Company/Names</th><th>Amount</th><th>Receipt</th><th></th>
        </tr>
      </thead>
      <tbody id="expense-lines"></tbody>
    </table>
  </div>

  <button type="button" class="btn btn-outline-primary" id="add-line-btn">Add Line</button>
  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-secondary" name="submit_action" value="save_draft">Save Draft</button>
    <button class="btn btn-primary" name="submit_action" value="submit_review">Submit for Review</button>
  </div>
</form>

<template id="expense-row-template">
  <tr>
    <td><input type="date" class="form-control" name="line_date" required /></td>
    <td>
      <select class="form-select" name="expense_type" required>
        <option value="">Select type</option>
        {% for expense_type in expense_types %}
        <option value="{{ expense_type }}">{{ expense_type }}</option>
        {% endfor %}
      </select>
    </td>
    <td>
      <select class="form-select" name="gl_account" required>
        <option value="">Loading GL accounts…</option>
      </select>
    </td>
    <td><input class="form-control" name="description" maxlength="255" /></td>
    <td><input class="form-control" name="vendor" maxlength="255" required /></td>
    <td><input type="number" class="form-control" name="amount" min="0" step="0.01" required /></td>
    <td><input type="file" class="form-control" accept="image/*,.pdf" /></td>
    <td><button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">Remove</button></td>
  </tr>
</template>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.getElementById("expense-lines");
    const template = document.getElementById("expense-row-template");
    const addButton = document.getElementById("add-line-btn");
    const glAccountsEndpoint = "{{ url_for('expenses.gl_accounts_options') }}";
    let glAccountOptions = [];

    const renameReceiptInputs = () => {
      tableBody.querySelectorAll("tr").forEach((row, index) => {
        const fileInput = row.querySelector('input[type="file"]');
        if (fileInput) {
          fileInput.name = `receipt_${index}`;
        }
      });
    };

    const setAccountCellMessage = (selectElement, message) => {
      selectElement.innerHTML = "";
      const option = document.createElement("option");
      option.value = "";
      option.textContent = message;
      selectElement.appendChild(option);
      selectElement.disabled = true;
    };

    const populateAccountSelect = (selectElement) => {
      selectElement.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select account";
      selectElement.appendChild(placeholder);

      glAccountOptions.forEach((optionData) => {
        const option = document.createElement("option");
        option.value = optionData.account;
        option.textContent = optionData.label;
        selectElement.appendChild(option);
      });

      selectElement.disabled = glAccountOptions.length === 0;
      if (glAccountOptions.length === 0) {
        placeholder.textContent = "No GL accounts available";
      }
    };

    const applyAccountsToExistingRows = () => {
      tableBody.querySelectorAll('select[name="gl_account"]').forEach((selectElement) => {
        populateAccountSelect(selectElement);
      });
    };

    const fetchGlAccounts = async () => {
      try {
        const response = await fetch(glAccountsEndpoint, {
          method: "GET",
          headers: { "Accept": "application/json" },
        });
        if (!response.ok) {
          throw new Error(`Failed to load GL accounts (${response.status})`);
        }

        const payload = await response.json();
        if (!payload || !Array.isArray(payload.accounts)) {
          throw new Error("GL accounts response was invalid.");
        }

        glAccountOptions = payload.accounts.filter((optionData) => {
          return optionData && optionData.account && optionData.label;
        });
        applyAccountsToExistingRows();
      } catch (error) {
        console.error(error);
        tableBody.querySelectorAll('select[name="gl_account"]').forEach((selectElement) => {
          setAccountCellMessage(selectElement, "Unable to load GL accounts");
        });
      }
    };

    const addLine = () => {
      const fragment = template.content.cloneNode(true);
      const row = fragment.querySelector("tr");
      const accountSelect = row.querySelector('select[name="gl_account"]');
      if (glAccountOptions.length > 0) {
        populateAccountSelect(accountSelect);
      } else {
        setAccountCellMessage(accountSelect, "Loading GL accounts…");
      }

      row.querySelector(".remove-line-btn").addEventListener("click", () => {
        row.remove();
        renameReceiptInputs();
      });
      tableBody.appendChild(row);
      renameReceiptInputs();
    };

    addButton.addEventListener("click", addLine);
    addLine();
    fetchGlAccounts();
  });
</script>
{% endblock %}
