{% extends "base.html" %}
{% block title %}New Expense Report{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">New Expense Report</h1>
  <a class="btn btn-outline-secondary" href="{{ url_for('expenses.my_reports') }}">My Reports</a>
</div>
<p class="text-muted">Reference workbook: <strong>{{ reference_workbook }}</strong> (Blank Expense Report, GL Accounts, Data List).</p>
<form method="post" enctype="multipart/form-data" id="expense-form">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <label class="form-label">Report Month</label>
      <input type="month" name="report_month" class="form-control" required />
    </div>
    <div class="col-md-4">
      <label class="form-label">Supervisor</label>
      <select class="form-select" name="supervisor_id" required>
        <option value="">Select supervisor</option>
        {% for supervisor in supervisors %}
        <option value="{{ supervisor.id }}">{{ supervisor.first_name or '' }} {{ supervisor.last_name or supervisor.email }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Notes</label>
      <input name="notes" class="form-control" maxlength="255" />
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="expense-lines-table">
      <thead class="table-light">
        <tr>
          <th>Date</th><th>Type</th><th>Account</th><th>Description</th><th>Company/Names</th><th>Amount</th><th>Receipt</th><th></th>
        </tr>
      </thead>
      <tbody id="expense-lines"></tbody>
    </table>
  </div>

  <button type="button" class="btn btn-outline-primary" id="add-line-btn">Add Line</button>
  <div class="mt-3 d-flex gap-2">
    <button class="btn btn-secondary" name="submit_action" value="save_draft">Save Draft</button>
    <button class="btn btn-primary" name="submit_action" value="submit_review">Submit for Review</button>
  </div>
</form>

<datalist id="gl-account-options">
  {% for option in gl_accounts %}
  <option value="{{ option.account }}">{{ option.label }}</option>
  {% endfor %}
</datalist>

<template id="expense-row-template">
  <tr>
    <td><input type="date" class="form-control" name="line_date" required /></td>
    <td>
      <select class="form-select" name="expense_type" required>
        <option value="">Select type</option>
        {% for expense_type in expense_types %}
        <option value="{{ expense_type }}">{{ expense_type }}</option>
        {% endfor %}
      </select>
    </td>
    <td><input class="form-control" name="gl_account" list="gl-account-options" placeholder="52070" required /></td>
    <td><input class="form-control" name="description" maxlength="255" /></td>
    <td><input class="form-control" name="vendor" maxlength="255" required /></td>
    <td><input type="number" class="form-control" name="amount" min="0" step="0.01" required /></td>
    <td><input type="file" class="form-control" accept="image/*,.pdf" /></td>
    <td><button type="button" class="btn btn-sm btn-outline-danger remove-line-btn">Remove</button></td>
  </tr>
</template>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.getElementById("expense-lines");
    const template = document.getElementById("expense-row-template");
    const addButton = document.getElementById("add-line-btn");

    const renameReceiptInputs = () => {
      tableBody.querySelectorAll("tr").forEach((row, index) => {
        const fileInput = row.querySelector('input[type="file"]');
        if (fileInput) {
          fileInput.name = `receipt_${index}`;
        }
      });
    };

    const addLine = () => {
      const fragment = template.content.cloneNode(true);
      const row = fragment.querySelector("tr");
      row.querySelector(".remove-line-btn").addEventListener("click", () => {
        row.remove();
        renameReceiptInputs();
      });
      tableBody.appendChild(row);
      renameReceiptInputs();
    };

    addButton.addEventListener("click", addLine);
    addLine();
  });
</script>
{% endblock %}
